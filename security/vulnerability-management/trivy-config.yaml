# Trivy Configuration for AIOps Learning Platform
# Comprehensive vulnerability scanning for containers, dependencies, and infrastructure

# Global settings
format: json
output: /tmp/trivy-results.json
severity: UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL
exit-code: 1  # Fail on any vulnerabilities

# Vulnerability database settings
db:
  repository: ghcr.io/aquasecurity/trivy-db
  skip-update: false

# Cache settings
cache:
  dir: /tmp/trivy-cache
  ttl: 24h

# Scanning options
scan:
  # Skip files and directories
  skip-files:
    - "**/*.md"
    - "**/*.txt" 
    - "**/README*"
    - "**/LICENSE*"
    - "**/.git/**"
    - "**/node_modules/**/.cache/**"
    - "**/test/**"
    - "**/tests/**"
    - "**/__tests__/**"
    - "**/*.test.js"
    - "**/*.spec.js"
  
  # Skip directories
  skip-dirs:
    - ".git"
    - "node_modules/.cache"
    - "coverage"
    - "dist"
    - "build"

# Security checks
security-checks:
  - vuln      # Vulnerabilities
  - config    # Misconfigurations  
  - secret    # Secrets
  - license   # License issues

# Vulnerability filtering
ignore:
  # Ignore specific CVEs (with justification)
  cves:
    # Example: Ignore development-only vulnerabilities
    - CVE-2021-44906  # minimist prototype pollution (dev dependency only)
  
  # Ignore vulnerabilities in specific paths
  paths:
    - "demo/**"      # Demo data, not production
    - "docs/**"      # Documentation only
    - "scripts/**"   # Build scripts, not runtime

# License policy
license:
  # Allowed licenses
  allow:
    - MIT
    - Apache-2.0
    - BSD-2-Clause
    - BSD-3-Clause
    - ISC
    - GPL-3.0
    - LGPL-2.1
  
  # Forbidden licenses
  deny:
    - GPL-2.0
    - AGPL-3.0
    - WTFPL

# Secret scanning
secret:
  # Secret patterns to detect
  patterns:
    - pattern: "(?i)(password|passwd|pwd)\\s*[=:]\\s*['\"]?[^\\s'\"]{8,}['\"]?"
      name: "Password"
    - pattern: "(?i)(api[_-]?key|apikey)\\s*[=:]\\s*['\"]?[a-zA-Z0-9]{16,}['\"]?"
      name: "API Key"
    - pattern: "(?i)(secret[_-]?key|secretkey)\\s*[=:]\\s*['\"]?[a-zA-Z0-9]{16,}['\"]?"
      name: "Secret Key"
    - pattern: "(?i)(jwt[_-]?secret|jwtsecret)\\s*[=:]\\s*['\"]?[a-zA-Z0-9]{16,}['\"]?"
      name: "JWT Secret"
    - pattern: "(?i)(database[_-]?url|databaseurl)\\s*[=:]\\s*['\"]?[^\\s'\"]+['\"]?"
      name: "Database URL"
    - pattern: "(?i)(redis[_-]?url|redisurl)\\s*[=:]\\s*['\"]?[^\\s'\"]+['\"]?"
      name: "Redis URL"

# Configuration checks
config:
  # Dockerfile checks
  dockerfile:
    - CKV_DOCKER_1   # Ensure port 22 is not exposed
    - CKV_DOCKER_2   # Ensure HEALTHCHECK is used
    - CKV_DOCKER_3   # Ensure user is not root
    - CKV_DOCKER_4   # Ensure COPY is used instead of ADD
    - CKV_DOCKER_5   # Ensure apt-get update and install are in same RUN
    - CKV_DOCKER_6   # Ensure LABEL maintainer is used
    - CKV_DOCKER_7   # Ensure FROM uses specific tag
    - CKV_DOCKER_8   # Ensure last USER is not root
    - CKV_DOCKER_9   # Ensure RUN apt-get update is followed by apt-get install
    - CKV_DOCKER_10  # Ensure shell commands use absolute paths

  # Kubernetes checks
  kubernetes:
    - CKV_K8S_1      # Process can elevate its own privileges
    - CKV_K8S_2      # Containers should not run with allowPrivilegeEscalation
    - CKV_K8S_3      # Containers should not run as root user
    - CKV_K8S_4      # Containers should not run with NET_RAW capability
    - CKV_K8S_5      # Containers should not run with SYS_ADMIN capability
    - CKV_K8S_6      # Containers should not run with privileged flag
    - CKV_K8S_7      # Containers should not share the host network namespace
    - CKV_K8S_8      # Containers should not share the host process ID namespace
    - CKV_K8S_9      # Containers should not share the host IPC namespace

# Reporting
report:
  # Report format options
  formats:
    - json
    - sarif
    - table
  
  # Include additional information
  include:
    - vulnerability-id
    - package-name
    - installed-version
    - fixed-version
    - severity
    - title
    - description
    - references

# Integration settings
integrations:
  # GitHub Actions
  github:
    token: ${GITHUB_TOKEN}
    upload-sarif: true
  
  # GitLab CI
  gitlab:
    token: ${GITLAB_TOKEN}
    upload-results: true

# Notification settings
notifications:
  # Slack notifications for critical vulnerabilities
  slack:
    webhook-url: ${SLACK_WEBHOOK_URL}
    channel: "#security-alerts"
    severity-threshold: HIGH
  
  # Email notifications
  email:
    smtp-server: ${SMTP_SERVER}
    recipients:
      - security-team@aiops-platform.com
      - devops-team@aiops-platform.com
    severity-threshold: CRITICAL

# Custom policies
policies:
  # Fail build on critical vulnerabilities
  fail-on:
    - severity: CRITICAL
      count: 0  # Fail on any critical vulnerability
    - severity: HIGH  
      count: 5   # Fail on more than 5 high vulnerabilities
    - severity: MEDIUM
      count: 20  # Fail on more than 20 medium vulnerabilities
  
  # License compliance
  license-policy:
    fail-on-forbidden: true
    warn-on-unknown: true

# Performance settings
performance:
  # Parallel scanning
  parallel: 4
  
  # Timeout settings
  timeout: 10m
  
  # Memory limits
  memory-limit: 2Gi