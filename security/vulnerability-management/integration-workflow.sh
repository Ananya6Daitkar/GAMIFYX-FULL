#!/bin/bash
# integration-workflow.sh - Complete vulnerability management integration workflow
# This script orchestrates the entire vulnerability management process

set -euo pipefail

# Configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"
LOG_DIR="$SCRIPT_DIR/logs"
REPORTS_DIR="$PROJECT_ROOT/security/reports"
TIMESTAMP=$(date +%Y%m%d-%H%M%S)
LOG_FILE="$LOG_DIR/integration-workflow-$TIMESTAMP.log"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Logging function
log() {
    local level=$1
    shift
    local message="$*"
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    
    case $level in
        INFO)
            echo -e "${GREEN}[INFO]${NC} $message" | tee -a "$LOG_FILE"
            ;;
        WARN)
            echo -e "${YELLOW}[WARN]${NC} $message" | tee -a "$LOG_FILE"
            ;;
        ERROR)
            echo -e "${RED}[ERROR]${NC} $message" | tee -a "$LOG_FILE"
            ;;
        DEBUG)
            echo -e "${BLUE}[DEBUG]${NC} $message" | tee -a "$LOG_FILE"
            ;;
        *)
            echo "[$timestamp] $message" | tee -a "$LOG_FILE"
            ;;
    esac
}

# Error handling
error_exit() {
    log ERROR "$1"
    cleanup
    exit 1
}

# Cleanup function
cleanup() {
    log INFO "Cleaning up temporary files..."
    if [[ -d "$TEMP_DIR" ]]; then
        rm -rf "$TEMP_DIR"
    fi
}

# Trap for cleanup
trap cleanup EXIT

# Create necessary directories
mkdir -p "$LOG_DIR" "$REPORTS_DIR"
TEMP_DIR=$(mktemp -d)

# Check prerequisites
check_prerequisites() {
    log INFO "Checking prerequisites..."
    
    local missing_tools=()
    
    # Check required tools
    command -v trivy >/dev/null 2>&1 || missing_tools+=("trivy")
    command -v python3 >/dev/null 2>&1 || missing_tools+=("python3")
    command -v node >/dev/null 2>&1 || missing_tools+=("node")
    command -v npm >/dev/null 2>&1 || missing_tools+=("npm")
    command -v git >/dev/null 2>&1 || missing_tools+=("git")
    command -v docker >/dev/null 2>&1 || missing_tools+=("docker")
    
    # Check optional tools
    if ! command -v semgrep >/dev/null 2>&1; then
        log WARN "semgrep not found - SAST scanning will be limited"
    fi
    
    if ! command -v checkov >/dev/null 2>&1; then
        log WARN "checkov not found - Infrastructure scanning will be limited"
    fi
    
    if [[ ${#missing_tools[@]} -gt 0 ]]; then
        error_exit "Missing required tools: ${missing_tools[*]}"
    fi
    
    # Check Python dependencies
    if ! python3 -c "import yaml, requests, numpy, sklearn" 2>/dev/null; then
        log WARN "Some Python dependencies are missing - installing..."
        pip3 install -r "$SCRIPT_DIR/requirements.txt" || error_exit "Failed to install Python dependencies"
    fi
    
    log INFO "Prerequisites check completed successfully"
}

# Generate Software Bill of Materials
generate_sbom() {
    log INFO "Generating Software Bill of Materials (SBOM)..."
    
    local sbom_output="$REPORTS_DIR/sbom-$TIMESTAMP"
    mkdir -p "$sbom_output"
    
    python3 "$SCRIPT_DIR/sbom-generator.py" \
        --project-root "$PROJECT_ROOT" \
        --output-dir "$sbom_output" \
        --formats cyclonedx spdx \
        --include-vulns || error_exit "SBOM generation failed"
    
    log INFO "SBOM generated successfully in $sbom_output"
}

# Run comprehensive vulnerability scanning
run_vulnerability_scan() {
    log INFO "Running comprehensive vulnerability scanning..."
    
    local scan_output="$TEMP_DIR/vulnerability-scan"
    mkdir -p "$scan_output"
    
    # Trivy filesystem scan
    log INFO "Running Trivy filesystem scan..."
    trivy fs \
        --config "$PROJECT_ROOT/security/trivy/trivy-config.yaml" \
        --format json \
        --output "$scan_output/trivy-fs.json" \
        --severity MEDIUM,HIGH,CRITICAL \
        "$PROJECT_ROOT" || log WARN "Trivy filesystem scan completed with warnings"
    
    # Trivy container image scan
    log INFO "Running Trivy container image scan..."
    if docker images --format "table {{.Repository}}:{{.Tag}}" | grep -q "gamifyx"; then
        docker images --format "{{.Repository}}:{{.Tag}}" | grep "gamifyx" | while read -r image; do
            log INFO "Scanning container image: $image"
            trivy image \
                --format json \
                --output "$scan_output/trivy-image-$(echo "$image" | tr '/:' '-').json" \
                --severity HIGH,CRITICAL \
                "$image" || log WARN "Container scan for $image completed with warnings"
        done
    else
        log WARN "No GamifyX container images found for scanning"
    fi
    
    # SAST scanning with Semgrep
    if command -v semgrep >/dev/null 2>&1; then
        log INFO "Running SAST scan with Semgrep..."
        semgrep \
            --config=auto \
            --json \
            --output="$scan_output/semgrep-results.json" \
            "$PROJECT_ROOT" || log WARN "Semgrep scan completed with warnings"
    fi
    
    # Infrastructure scanning with Checkov
    if command -v checkov >/dev/null 2>&1; then
        log INFO "Running infrastructure scan with Checkov..."
        checkov \
            -d "$PROJECT_ROOT/infrastructure" \
            --framework terraform,kubernetes,dockerfile \
            --output json \
            --output-file "$scan_output/checkov-results.json" || log WARN "Checkov scan completed with warnings"
    fi
    
    # ESLint security scan
    if [[ -f "$PROJECT_ROOT/frontend/package.json" ]]; then
        log INFO "Running ESLint security scan..."
        cd "$PROJECT_ROOT/frontend"
        npx eslint \
            --config "$PROJECT_ROOT/.eslintrc.security.js" \
            --format json \
            --output-file "$scan_output/eslint-security.json" \
            "src/**/*.{js,ts,jsx,tsx}" || log WARN "ESLint security scan completed with warnings"
        cd - > /dev/null
    fi
    
    # Secret scanning with TruffleHog
    if command -v truffleHog >/dev/null 2>&1; then
        log INFO "Running secret scan with TruffleHog..."
        truffleHog \
            --json \
            --output "$scan_output/trufflehog-results.json" \
            "$PROJECT_ROOT" || log WARN "TruffleHog scan completed with warnings"
    fi
    
    log INFO "Vulnerability scanning completed"
}

# Analyze vulnerabilities with ML-powered risk assessment
analyze_vulnerabilities() {
    log INFO "Analyzing vulnerabilities with ML-powered risk assessment..."
    
    python3 "$SCRIPT_DIR/analyze-vulnerabilities.py" \
        --input-dir "$TEMP_DIR/vulnerability-scan" \
        --output-file "$TEMP_DIR/vulnerability-analysis.json" \
        --config "$SCRIPT_DIR/config.yaml" || error_exit "Vulnerability analysis failed"
    
    log INFO "Vulnerability analysis completed"
}

# Generate remediation plan
generate_remediation_plan() {
    log INFO "Generating automated remediation plan..."
    
    python3 "$SCRIPT_DIR/generate-remediation-plan.py" \
        --analysis-file "$TEMP_DIR/vulnerability-analysis.json" \
        --output-file "$TEMP_DIR/remediation-plan.json" \
        --config "$SCRIPT_DIR/config.yaml" || error_exit "Remediation plan generation failed"
    
    log INFO "Remediation plan generated"
}

# Execute automated remediation
execute_remediation() {
    log INFO "Executing automated remediation strategies..."
    
    # Create backup before remediation
    log INFO "Creating backup before remediation..."
    git stash push -m "Pre-remediation backup - $TIMESTAMP" || log WARN "Failed to create git backup"
    
    # Execute remediation
    python3 "$SCRIPT_DIR/execute-remediation.py" \
        --plan-file "$TEMP_DIR/remediation-plan.json" \
        --working-dir "$TEMP_DIR" \
        --config "$SCRIPT_DIR/config.yaml" || {
            log ERROR "Remediation execution failed - rolling back changes"
            git stash pop || log WARN "Failed to rollback changes"
            error_exit "Automated remediation failed"
        }
    
    log INFO "Automated remediation completed"
}

# Validate remediation effectiveness
validate_remediation() {
    log INFO "Validating remediation effectiveness..."
    
    # Re-run vulnerability scan
    log INFO "Running post-remediation vulnerability scan..."
    local post_scan_output="$TEMP_DIR/post-remediation-scan"
    mkdir -p "$post_scan_output"
    
    trivy fs \
        --config "$PROJECT_ROOT/security/trivy/trivy-config.yaml" \
        --format json \
        --output "$post_scan_output/trivy-post-remediation.json" \
        --severity MEDIUM,HIGH,CRITICAL \
        "$PROJECT_ROOT" || log WARN "Post-remediation scan completed with warnings"
    
    # Run automated tests
    log INFO "Running automated tests..."
    run_automated_tests || {
        log ERROR "Automated tests failed after remediation - rolling back"
        git stash pop || log WARN "Failed to rollback changes"
        error_exit "Remediation validation failed"
    }
    
    # Compare before and after
    python3 "$SCRIPT_DIR/compare-scan-results.py" \
        --before "$TEMP_DIR/vulnerability-scan/trivy-fs.json" \
        --after "$post_scan_output/trivy-post-remediation.json" \
        --output "$TEMP_DIR/remediation-effectiveness.json" || log WARN "Scan comparison failed"
    
    log INFO "Remediation validation completed"
}

# Run automated tests
run_automated_tests() {
    log INFO "Running comprehensive automated tests..."
    
    local test_results=0
    
    # Frontend tests
    if [[ -f "$PROJECT_ROOT/frontend/package.json" ]]; then
        log INFO "Running frontend tests..."
        cd "$PROJECT_ROOT/frontend"
        npm test -- --watchAll=false --coverage || {
            log ERROR "Frontend tests failed"
            test_results=1
        }
        cd - > /dev/null
    fi
    
    # Backend service tests
    for service_dir in "$PROJECT_ROOT"/services/*/; do
        if [[ -f "$service_dir/package.json" ]]; then
            service_name=$(basename "$service_dir")
            log INFO "Running tests for service: $service_name"
            cd "$service_dir"
            npm test || {
                log ERROR "Tests failed for service: $service_name"
                test_results=1
            }
            cd - > /dev/null
        fi
    done
    
    # Integration tests
    if [[ -f "$PROJECT_ROOT/tests/integration/package.json" ]]; then
        log INFO "Running integration tests..."
        cd "$PROJECT_ROOT/tests/integration"
        npm test || {
            log ERROR "Integration tests failed"
            test_results=1
        }
        cd - > /dev/null
    fi
    
    # Security tests
    if [[ -f "$PROJECT_ROOT/tests/security/package.json" ]]; then
        log INFO "Running security tests..."
        cd "$PROJECT_ROOT/tests/security"
        npm test || {
            log ERROR "Security tests failed"
            test_results=1
        }
        cd - > /dev/null
    fi
    
    return $test_results
}

# Generate comprehensive reports
generate_reports() {
    log INFO "Generating comprehensive security reports..."
    
    local report_output="$REPORTS_DIR/vulnerability-management-$TIMESTAMP"
    mkdir -p "$report_output"
    
    # Copy all scan results and analysis
    cp -r "$TEMP_DIR"/* "$report_output/" 2>/dev/null || true
    
    # Generate executive summary
    python3 "$SCRIPT_DIR/generate-reports.py" \
        --input-dir "$TEMP_DIR" \
        --output-dir "$report_output" \
        --config "$SCRIPT_DIR/config.yaml" || log WARN "Report generation completed with warnings"
    
    # Generate compliance reports
    python3 "$SCRIPT_DIR/generate-compliance-report.py" \
        --vulnerability-data "$TEMP_DIR/vulnerability-analysis.json" \
        --remediation-data "$TEMP_DIR/remediation-plan.json" \
        --output-file "$report_output/compliance-report.json" \
        --frameworks NIST,ISO27001,SOC2,GDPR,FERPA || log WARN "Compliance report generation failed"
    
    # Create HTML dashboard
    if command -v pandoc >/dev/null 2>&1; then
        log INFO "Generating HTML dashboard..."
        python3 "$SCRIPT_DIR/generate-dashboard.py" \
            --data-dir "$report_output" \
            --output-file "$report_output/security-dashboard.html" || log WARN "Dashboard generation failed"
    fi
    
    log INFO "Reports generated in $report_output"
}

# Send notifications
send_notifications() {
    log INFO "Sending notifications..."
    
    python3 "$SCRIPT_DIR/send-notifications.py" \
        --results-dir "$TEMP_DIR" \
        --config "$SCRIPT_DIR/config.yaml" || log WARN "Notification sending failed"
    
    log INFO "Notifications sent"
}

# Update security metrics
update_metrics() {
    log INFO "Updating security metrics..."
    
    # Push metrics to Prometheus if available
    if [[ -n "${PROMETHEUS_PUSHGATEWAY_URL:-}" ]]; then
        python3 "$SCRIPT_DIR/push-metrics.py" \
            --results-dir "$TEMP_DIR" \
            --pushgateway-url "$PROMETHEUS_PUSHGATEWAY_URL" || log WARN "Metrics push failed"
    fi
    
    # Update security dashboard
    if [[ -f "$PROJECT_ROOT/monitoring/grafana/dashboards/security/security-metrics.json" ]]; then
        python3 "$SCRIPT_DIR/update-dashboard-metrics.py" \
            --results-dir "$TEMP_DIR" \
            --dashboard-file "$PROJECT_ROOT/monitoring/grafana/dashboards/security/security-metrics.json" || log WARN "Dashboard metrics update failed"
    fi
    
    log INFO "Security metrics updated"
}

# Main workflow execution
main() {
    log INFO "Starting GamifyX Vulnerability Management Integration Workflow"
    log INFO "Timestamp: $TIMESTAMP"
    log INFO "Project Root: $PROJECT_ROOT"
    log INFO "Log File: $LOG_FILE"
    
    # Execute workflow steps
    check_prerequisites
    generate_sbom
    run_vulnerability_scan
    analyze_vulnerabilities
    generate_remediation_plan
    
    # Ask for confirmation before executing remediation
    if [[ "${AUTO_REMEDIATE:-false}" != "true" ]]; then
        echo
        log INFO "Remediation plan generated. Review the plan at: $TEMP_DIR/remediation-plan.json"
        read -p "Do you want to execute automated remediation? (y/N): " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            log INFO "Skipping automated remediation as requested"
            generate_reports
            send_notifications
            update_metrics
            log INFO "Workflow completed without remediation"
            return 0
        fi
    fi
    
    execute_remediation
    validate_remediation
    generate_reports
    send_notifications
    update_metrics
    
    log INFO "GamifyX Vulnerability Management Integration Workflow completed successfully"
    
    # Print summary
    echo
    echo "=========================================="
    echo "VULNERABILITY MANAGEMENT WORKFLOW SUMMARY"
    echo "=========================================="
    echo "Timestamp: $TIMESTAMP"
    echo "Log File: $LOG_FILE"
    echo "Reports: $REPORTS_DIR/vulnerability-management-$TIMESTAMP"
    echo "SBOM: $REPORTS_DIR/sbom-$TIMESTAMP"
    echo
    
    if [[ -f "$TEMP_DIR/vulnerability-analysis.json" ]]; then
        python3 -c "
import json
with open('$TEMP_DIR/vulnerability-analysis.json', 'r') as f:
    data = json.load(f)
print(f\"Total Vulnerabilities: {data.get('total_vulnerabilities', 0)}\")
print(f\"High Risk: {data.get('high_risk_count', 0)}\")
print(f\"Medium Risk: {data.get('medium_risk_count', 0)}\")
print(f\"Low Risk: {data.get('low_risk_count', 0)}\")
"
    fi
    
    echo "=========================================="
}

# Handle command line arguments
case "${1:-}" in
    --help|-h)
        echo "Usage: $0 [OPTIONS]"
        echo
        echo "Options:"
        echo "  --auto-remediate    Execute remediation without confirmation"
        echo "  --skip-remediation  Skip automated remediation"
        echo "  --help, -h          Show this help message"
        echo
        echo "Environment Variables:"
        echo "  AUTO_REMEDIATE              Set to 'true' to skip remediation confirmation"
        echo "  PROMETHEUS_PUSHGATEWAY_URL  URL for Prometheus Pushgateway"
        echo "  SLACK_WEBHOOK_URL           Slack webhook for notifications"
        echo "  GITHUB_TOKEN                GitHub token for creating PRs"
        exit 0
        ;;
    --auto-remediate)
        export AUTO_REMEDIATE=true
        ;;
    --skip-remediation)
        export SKIP_REMEDIATION=true
        ;;
esac

# Execute main workflow
main "$@"