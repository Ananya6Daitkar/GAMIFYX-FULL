# Docker Compose Override for Enhanced Secrets Management
# Use with: docker-compose -f docker-compose.yml -f docker-compose.secrets.yml up

version: '3.8'

services:
  # Enhanced Vault configuration for production-like setup
  vault:
    environment:
      VAULT_DEV_ROOT_TOKEN_ID: dev-token
      VAULT_DEV_LISTEN_ADDRESS: 0.0.0.0:8200
      VAULT_LOG_LEVEL: info
      VAULT_DISABLE_MLOCK: true
    volumes:
      - vault_data:/vault/data
      - vault_logs:/vault/logs
      - ./services/secrets-manager/vault-config:/vault/config
    command: |
      sh -c '
        vault server -dev \
          -dev-root-token-id=dev-token \
          -dev-listen-address=0.0.0.0:8200 \
          -log-level=info
      '
    healthcheck:
      test: ["CMD", "vault", "status"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # Enhanced Secrets Manager with comprehensive features
  secrets-manager:
    environment:
      # Enhanced Vault Configuration
      VAULT_ENDPOINT: http://vault:8200
      VAULT_TOKEN: dev-token
      VAULT_NAMESPACE: ""
      VAULT_API_VERSION: v1
      VAULT_TIMEOUT: 30000
      VAULT_RETRIES: 3
      
      # Enhanced Database Configuration
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: aiops_secrets
      DB_USER: postgres
      DB_PASSWORD: password
      DB_SSL: false
      DB_POOL_SIZE: 20
      DB_CONNECTION_TIMEOUT: 30000
      
      # Enhanced Security Configuration
      JWT_SECRET: aiops-super-secret-jwt-key-for-development-only
      JWT_EXPIRES_IN: 15m
      JWT_REFRESH_EXPIRES_IN: 7d
      ENCRYPTION_KEY: aiops-master-encryption-key-32-chars
      
      # Audit Configuration
      AUDIT_LOG_PATH: /app/logs/audit
      AUDIT_LOG_LEVEL: info
      AUDIT_RETENTION_DAYS: 90
      
      # Notification Configuration
      SLACK_WEBHOOK_URL: ${SLACK_WEBHOOK_URL:-}
      EMAIL_HOST: ${EMAIL_HOST:-smtp.gmail.com}
      EMAIL_PORT: ${EMAIL_PORT:-587}
      EMAIL_SECURE: ${EMAIL_SECURE:-true}
      EMAIL_USER: ${EMAIL_USER:-}
      EMAIL_PASS: ${EMAIL_PASS:-}
      
      # Rotation Configuration
      ROTATION_CHECK_INTERVAL: 3600000  # 1 hour
      ROTATION_DEFAULT_INTERVAL_DAYS: 90
      ROTATION_MIN_INTERVAL_DAYS: 1
      ROTATION_MAX_RETRIES: 3
      ROTATION_BACKOFF_MULTIPLIER: 2
      
      # CI/CD Integration
      ALLOWED_CICD_PLATFORMS: github-actions,gitlab-ci,jenkins,azure-devops,circleci
      CICD_TOKEN_TTL: 3600  # 1 hour
      CICD_RATE_LIMIT: 100  # requests per hour
      
      # Monitoring and Observability
      METRICS_PORT: 9003
      JAEGER_ENDPOINT: http://jaeger:14268/api/traces
      PROMETHEUS_ENDPOINT: http://prometheus:9090
      LOG_LEVEL: info
      
      # Performance Configuration
      CACHE_TTL: 300  # 5 minutes
      MAX_SECRET_SIZE: 1048576  # 1MB
      CONNECTION_POOL_SIZE: 20
      REQUEST_TIMEOUT: 30000
      
      # Feature Flags
      ENABLE_DYNAMIC_CREDENTIALS: true
      ENABLE_SECRET_INJECTION: true
      ENABLE_COMPREHENSIVE_AUDIT: true
      ENABLE_SECURITY_ALERTS: true
      ENABLE_COMPLIANCE_REPORTING: true
      
      # Development Features
      ENABLE_VAULT_UI: true
      ENABLE_DEBUG_LOGGING: true
      ENABLE_METRICS_ENDPOINT: true
    
    volumes:
      - secrets_logs:/app/logs
      - secrets_audit:/app/logs/audit
      - secrets_config:/app/config
    
    ports:
      - "3003:3003"
      - "9003:9003"  # Metrics port
    
    depends_on:
      vault:
        condition: service_healthy
      postgres:
        condition: service_healthy
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3003/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Enhanced services with secrets integration
  user-service:
    environment:
      # Secrets Manager Integration
      SECRETS_MANAGER_URL: http://secrets-manager:3003
      VAULT_ENDPOINT: http://vault:8200
      VAULT_TOKEN: dev-token
      
      # Enhanced JWT Configuration
      JWT_SECRET: ${VAULT_JWT_SECRET:-aiops-super-secret-jwt-key-for-development-only}
      JWT_REFRESH_SECRET: ${VAULT_JWT_REFRESH_SECRET:-aiops-super-secret-refresh-key-for-development-only}
      
      # Enhanced Database Configuration
      DB_PASSWORD: ${VAULT_DB_PASSWORD:-password}
      
      # Session Configuration
      SESSION_SECRET: ${VAULT_SESSION_SECRET:-session-secret-key}
    
    depends_on:
      secrets-manager:
        condition: service_healthy

  gamification-service:
    environment:
      # Secrets Manager Integration
      SECRETS_MANAGER_URL: http://secrets-manager:3003
      VAULT_ENDPOINT: http://vault:8200
      VAULT_TOKEN: dev-token
      
      # Enhanced Configuration
      JWT_SECRET: ${VAULT_JWT_SECRET:-aiops-super-secret-jwt-key-for-development-only}
      DB_PASSWORD: ${VAULT_DB_PASSWORD:-password}
      WEBSOCKET_SECRET: ${VAULT_WEBSOCKET_SECRET:-websocket-secret-key}
      LEADERBOARD_ENCRYPTION_KEY: ${VAULT_LEADERBOARD_KEY:-leaderboard-encryption-key}
    
    depends_on:
      secrets-manager:
        condition: service_healthy

  analytics-service:
    environment:
      # Secrets Manager Integration
      SECRETS_MANAGER_URL: http://secrets-manager:3003
      VAULT_ENDPOINT: http://vault:8200
      VAULT_TOKEN: dev-token
      
      # Enhanced Configuration
      JWT_SECRET: ${VAULT_JWT_SECRET:-aiops-super-secret-jwt-key-for-development-only}
      DB_PASSWORD: ${VAULT_DB_PASSWORD:-password}
      INFLUXDB_TOKEN: ${VAULT_INFLUXDB_TOKEN:-aiops-admin-token-for-development}
      METRICS_ENCRYPTION_KEY: ${VAULT_METRICS_KEY:-metrics-encryption-key}
    
    depends_on:
      secrets-manager:
        condition: service_healthy

  ai-feedback-service:
    environment:
      # Secrets Manager Integration
      SECRETS_MANAGER_URL: http://secrets-manager:3003
      VAULT_ENDPOINT: http://vault:8200
      VAULT_TOKEN: dev-token
      
      # Enhanced AI Configuration
      OPENAI_API_KEY: ${VAULT_OPENAI_KEY:-your-openai-api-key-here}
      HUGGINGFACE_API_KEY: ${VAULT_HUGGINGFACE_KEY:-your-huggingface-api-key-here}
      DATABASE_URL: postgresql://postgres:${VAULT_DB_PASSWORD:-password}@postgres:5432/aiops_learning_platform
      MODEL_ENCRYPTION_KEY: ${VAULT_MODEL_KEY:-model-encryption-key}
    
    depends_on:
      secrets-manager:
        condition: service_healthy

  api-gateway:
    environment:
      # Secrets Manager Integration
      SECRETS_MANAGER_URL: http://secrets-manager:3003
      VAULT_ENDPOINT: http://vault:8200
      VAULT_TOKEN: dev-token
      
      # Enhanced Gateway Configuration
      JWT_SECRET: ${VAULT_JWT_SECRET:-aiops-super-secret-jwt-key-for-development-only}
      WEBSOCKET_SECRET: ${VAULT_WEBSOCKET_SECRET:-websocket-secret-key}
      RATE_LIMIT_KEY: ${VAULT_RATE_LIMIT_KEY:-rate-limit-key}
      CORS_SECRET: ${VAULT_CORS_SECRET:-cors-secret-key}
    
    depends_on:
      secrets-manager:
        condition: service_healthy

  # Vault UI for development (optional)
  vault-ui:
    image: djenriquez/vault-ui:latest
    container_name: aiops-vault-ui
    ports:
      - "8000:8000"
    environment:
      VAULT_URL_DEFAULT: http://vault:8200
      VAULT_AUTH_DEFAULT: TOKEN
    depends_on:
      - vault
    networks:
      - aiops-network
    profiles:
      - vault-ui

  # Secret rotation scheduler
  secret-rotator:
    build:
      context: ./services/secrets-manager
      dockerfile: Dockerfile
    container_name: aiops-secret-rotator
    environment:
      NODE_ENV: development
      VAULT_ENDPOINT: http://vault:8200
      VAULT_TOKEN: dev-token
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: aiops_secrets
      DB_USER: postgres
      DB_PASSWORD: password
      ROTATION_MODE: scheduler
      ROTATION_INTERVAL: 3600000  # 1 hour checks
    command: ["node", "dist/scripts/rotation-scheduler.js"]
    depends_on:
      vault:
        condition: service_healthy
      postgres:
        condition: service_healthy
    networks:
      - aiops-network
    profiles:
      - rotation

volumes:
  vault_data:
    driver: local
  vault_logs:
    driver: local
  secrets_logs:
    driver: local
  secrets_audit:
    driver: local
  secrets_config:
    driver: local

networks:
  aiops-network:
    external: true