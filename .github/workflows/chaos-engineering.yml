name: Chaos Engineering Experiments

on:
  workflow_dispatch:
    inputs:
      experiment_type:
        description: 'Type of chaos experiment to run'
        required: true
        default: 'traffic-spike'
        type: choice
        options:
        - traffic-spike
        - dependency-failure
        - cpu-stress
        - network-latency
      duration:
        description: 'Experiment duration in minutes'
        required: true
        default: '5'
        type: string
      environment:
        description: 'Target environment'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - development
  schedule:
    # Run weekly chaos experiments on Fridays at 2 PM UTC
    - cron: '0 14 * * 5'

env:
  EXPERIMENT_TAG: "experiment=true"
  SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}

jobs:
  pre-experiment-check:
    runs-on: ubuntu-latest
    outputs:
      steady-state: ${{ steps.health-check.outputs.healthy }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check service health
        id: health-check
        run: |
          # Check if services are in steady state
          echo "Checking service health..."
          
          # This would typically check your monitoring endpoints
          # For demo purposes, we'll simulate the check
          HEALTHY="true"
          
          if [ "$HEALTHY" = "true" ]; then
            echo "âœ… Services are healthy and ready for chaos experiment"
            echo "healthy=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Services are not in steady state. Aborting experiment."
            echo "healthy=false" >> $GITHUB_OUTPUT
            exit 1
          fi

  chaos-experiment:
    needs: pre-experiment-check
    if: needs.pre-experiment-check.outputs.steady-state == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup experiment environment
        run: |
          echo "ðŸ§ª Setting up chaos experiment environment"
          echo "Experiment: ${{ github.event.inputs.experiment_type || 'traffic-spike' }}"
          echo "Duration: ${{ github.event.inputs.duration || '5' }} minutes"
          echo "Environment: ${{ github.event.inputs.environment || 'staging' }}"
          
          # Create experiment metadata
          cat > experiment_metadata.json << EOF
          {
            "experiment_id": "${{ github.run_id }}",
            "experiment_type": "${{ github.event.inputs.experiment_type || 'traffic-spike' }}",
            "duration_minutes": "${{ github.event.inputs.duration || '5' }}",
            "environment": "${{ github.event.inputs.environment || 'staging' }}",
            "started_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "triggered_by": "${{ github.actor }}",
            "repository": "${{ github.repository }}",
            "commit_sha": "${{ github.sha }}"
          }
          EOF

      - name: Notify experiment start
        run: |
          if [ -n "$SLACK_WEBHOOK" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data '{
                "text": "ðŸ§ª Chaos Experiment Started",
                "attachments": [{
                  "color": "warning",
                  "fields": [
                    {"title": "Experiment", "value": "${{ github.event.inputs.experiment_type || 'traffic-spike' }}", "short": true},
                    {"title": "Duration", "value": "${{ github.event.inputs.duration || '5' }} minutes", "short": true},
                    {"title": "Environment", "value": "${{ github.event.inputs.environment || 'staging' }}", "short": true},
                    {"title": "Run ID", "value": "${{ github.run_id }}", "short": true}
                  ]
                }]
              }' \
              $SLACK_WEBHOOK
          fi

      - name: Capture baseline metrics
        run: |
          echo "ðŸ“Š Capturing baseline metrics..."
          mkdir -p chaos/results/${{ github.run_id }}
          
          # Capture baseline metrics (would typically call your monitoring API)
          echo '{"timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'", "phase": "baseline", "metrics": {"p95_latency": 150, "error_rate": 0.1, "cpu_usage": 35}}' > chaos/results/${{ github.run_id }}/baseline_metrics.json

      - name: Run chaos experiment
        id: chaos-experiment
        run: |
          echo "ðŸš€ Running chaos experiment: ${{ github.event.inputs.experiment_type || 'traffic-spike' }}"
          
          EXPERIMENT_TYPE="${{ github.event.inputs.experiment_type || 'traffic-spike' }}"
          DURATION="${{ github.event.inputs.duration || '5' }}"
          
          case $EXPERIMENT_TYPE in
            "traffic-spike")
              echo "Running traffic spike experiment..."
              # In a real scenario, this would run your traffic spike script
              echo "Simulating traffic spike for $DURATION minutes..."
              sleep 30  # Simulate experiment duration (shortened for demo)
              echo "experiment_result=success" >> $GITHUB_OUTPUT
              ;;
            "dependency-failure")
              echo "Running dependency failure experiment..."
              echo "Simulating dependency failure for $DURATION minutes..."
              sleep 30
              echo "experiment_result=success" >> $GITHUB_OUTPUT
              ;;
            "cpu-stress")
              echo "Running CPU stress experiment..."
              echo "Simulating CPU stress for $DURATION minutes..."
              sleep 30
              echo "experiment_result=success" >> $GITHUB_OUTPUT
              ;;
            *)
              echo "Unknown experiment type: $EXPERIMENT_TYPE"
              echo "experiment_result=failed" >> $GITHUB_OUTPUT
              exit 1
              ;;
          esac

      - name: Capture post-experiment metrics
        run: |
          echo "ðŸ“Š Capturing post-experiment metrics..."
          
          # Capture post-experiment metrics
          echo '{"timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'", "phase": "post-experiment", "metrics": {"p95_latency": 180, "error_rate": 0.3, "cpu_usage": 40}}' > chaos/results/${{ github.run_id }}/post_experiment_metrics.json

      - name: Generate experiment report
        run: |
          echo "ðŸ“‹ Generating experiment report..."
          
          cat > chaos/results/${{ github.run_id }}/experiment_report.md << EOF
          # Chaos Experiment Report
          
          **Experiment ID:** ${{ github.run_id }}
          **Type:** ${{ github.event.inputs.experiment_type || 'traffic-spike' }}
          **Duration:** ${{ github.event.inputs.duration || '5' }} minutes
          **Environment:** ${{ github.event.inputs.environment || 'staging' }}
          **Status:** ${{ steps.chaos-experiment.outputs.experiment_result }}
          **Executed By:** ${{ github.actor }}
          **Timestamp:** $(date -u +%Y-%m-%dT%H:%M:%SZ)
          
          ## Results
          - Experiment completed successfully
          - System remained stable throughout the test
          - Recovery time: < 2 minutes
          - No manual intervention required
          
          ## Artifacts
          - baseline_metrics.json
          - post_experiment_metrics.json
          - experiment_metadata.json
          EOF

      - name: Upload experiment artifacts
        uses: actions/upload-artifact@v4
        with:
          name: chaos-experiment-${{ github.run_id }}
          path: chaos/results/${{ github.run_id }}/
          retention-days: 30

      - name: Notify experiment completion
        if: always()
        run: |
          STATUS="${{ steps.chaos-experiment.outputs.experiment_result }}"
          COLOR="good"
          if [ "$STATUS" != "success" ]; then
            COLOR="danger"
          fi
          
          if [ -n "$SLACK_WEBHOOK" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data '{
                "text": "ðŸ§ª Chaos Experiment Completed",
                "attachments": [{
                  "color": "'$COLOR'",
                  "fields": [
                    {"title": "Status", "value": "'$STATUS'", "short": true},
                    {"title": "Experiment", "value": "${{ github.event.inputs.experiment_type || 'traffic-spike' }}", "short": true},
                    {"title": "Duration", "value": "${{ github.event.inputs.duration || '5' }} minutes", "short": true},
                    {"title": "Run ID", "value": "${{ github.run_id }}", "short": true}
                  ]
                }]
              }' \
              $SLACK_WEBHOOK
          fi

  post-experiment-validation:
    needs: chaos-experiment
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Validate system recovery
        run: |
          echo "ðŸ” Validating system recovery..."
          
          # Wait for system to stabilize
          sleep 60
          
          # Check if services are back to steady state
          echo "âœ… System has recovered to steady state"
          
      - name: Update chaos engineering metrics
        run: |
          echo "ðŸ“ˆ Updating chaos engineering metrics..."
          echo "Experiment completed successfully"
          echo "System resilience validated"