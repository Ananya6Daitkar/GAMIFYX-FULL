apiVersion: 1

contactPoints:
  - orgId: 1
    name: slack-contact
    receivers:
      - uid: slack-receiver
        type: slack
        settings:
          url: "${SLACK_WEBHOOK_URL}"
          channel: "#aiops-alerts"
          username: "AIOps Grafana"
          title: "{{ .GroupLabels.alertname }} - {{ .Status | title }}"
          text: |
            {{ range .Alerts }}
            **Summary:** {{ .Annotations.summary }}
            **Description:** {{ .Annotations.description }}
            **Severity:** {{ .Labels.severity }}
            **Team:** {{ .Labels.team }}
            **Status:** {{ .Status }}
            **Started:** {{ .StartsAt.Format "2006-01-02 15:04:05" }}
            {{ if ne .Status "firing" }}**Resolved:** {{ .EndsAt.Format "2006-01-02 15:04:05" }}{{ end }}
            ---
            {{ end }}
          iconEmoji: ":warning:"

  - orgId: 1
    name: email-contact
    receivers:
      - uid: email-receiver
        type: email
        settings:
          addresses:
            - "${ADMIN_EMAIL}"
            - "${TEACHER_EMAIL}"
          subject: "[AIOps Alert] {{ .GroupLabels.alertname }}"
          body: |
            <h2>AIOps Learning Platform Alert</h2>
            <p><strong>Alert Group:</strong> {{ .GroupLabels.alertname }}</p>
            <p><strong>Status:</strong> {{ .Status | title }}</p>
            
            {{ range .Alerts }}
            <div style="border: 1px solid #ddd; padding: 10px; margin: 10px 0;">
              <h3>{{ .Annotations.summary }}</h3>
              <p><strong>Description:</strong> {{ .Annotations.description }}</p>
              <p><strong>Severity:</strong> <span style="color: {{ if eq .Labels.severity "critical" }}red{{ else if eq .Labels.severity "warning" }}orange{{ else }}blue{{ end }};">{{ .Labels.severity | title }}</span></p>
              <p><strong>Team:</strong> {{ .Labels.team }}</p>
              <p><strong>Started:</strong> {{ .StartsAt.Format "2006-01-02 15:04:05 MST" }}</p>
              {{ if ne .Status "firing" }}<p><strong>Resolved:</strong> {{ .EndsAt.Format "2006-01-02 15:04:05 MST" }}</p>{{ end }}
              
              <h4>Labels:</h4>
              <ul>
              {{ range .Labels.SortedPairs }}
                <li><strong>{{ .Name }}:</strong> {{ .Value }}</li>
              {{ end }}
              </ul>
            </div>
            {{ end }}

  - orgId: 1
    name: webhook-contact
    receivers:
      - uid: webhook-receiver
        type: webhook
        settings:
          url: "${WEBHOOK_URL}"
          httpMethod: POST
          body: |
            {
              "receiver": "{{ .Receiver }}",
              "status": "{{ .Status }}",
              "groupKey": "{{ .GroupKey }}",
              "groupLabels": {{ .GroupLabels | toJson }},
              "commonLabels": {{ .CommonLabels | toJson }},
              "commonAnnotations": {{ .CommonAnnotations | toJson }},
              "externalURL": "{{ .ExternalURL }}",
              "alerts": [
                {{ range $index, $alert := .Alerts }}
                {{ if $index }},{{ end }}
                {
                  "status": "{{ $alert.Status }}",
                  "labels": {{ $alert.Labels | toJson }},
                  "annotations": {{ $alert.Annotations | toJson }},
                  "startsAt": "{{ $alert.StartsAt }}",
                  "endsAt": "{{ $alert.EndsAt }}",
                  "generatorURL": "{{ $alert.GeneratorURL }}",
                  "fingerprint": "{{ $alert.Fingerprint }}"
                }
                {{ end }}
              ]
            }